# 中文自然语言时间解析器 (CN2T)

灵活、轻量级的中文自然语言时间解析器。  
能够将各种中文时间表达式转换为时间范围。  
通过自定义lexicon和template，可以实现更复杂的语法解析，~~当然也可以用来解析别的语言（确信~~  
  
理论上，对于中文来说，准确度能够远超[dateparser](https://github.com/scrapinghub/dateparser)。  
  
**整个项目不依赖任何大模型实现功能**

## 适用范围

- 支持几乎所有常见的时间格式，不支持的是因为lexicon还在继续写，在写了在写了.jpg
- 仅支持阳历（格里高利历）
- 暂不支持农历、阴历
- 目前还不能解析嵌入句子中的时间，这点和[cn2an](https://github.com/Ailln/cn2an)不同（嗯都是NLP这么比较也没啥问题（确信

## 依赖项

```cmd
pip install cn2an cutword pyyaml python-dateutil
```
- [cn2an](https://github.com/Ailln/cn2an)：用于中文数字处理
- [cutword](https://github.com/liwenju0/cutword)：用于分词（感觉比jieba好用点，但是自定义词典只能从文件加载，想交pr了）
- [pyyaml](https://github.com/yaml/pyyaml)：用于解析yaml；说实话我真的很想把yaml编译成bson的，但是目前还不完备，所以作罢
- [dateutil](https://github.com/dateutil/dateutil)：用于提供relativedelta，这玩意太好用了你们知道吗.jpg

以及一个用来对比的
- [dateparser](https://github.com/scrapinghub/dateparser)：对比测试用的，比较抽象的是它会把`13月1日`解析成`1月13日`而不是拒绝解析（

## 快速开始

```python
from main import full_parse
# from main是因为这玩意是个模块不是个包……
# 虽然说我明明可以给它起个别的名字的但我就是叫main怎么你了（不是

result = full_parse("2025年8月15日下午3点半")
if result:
    start_time, end_time = result
    print(f"开始时间: {start_time.strftime('%Y-%m-%d %H:%M:%S')}")
    print(f"结束时间: {end_time.strftime('%Y-%m-%d %H:%M:%S')}")
else: # 失败会返回None
    print("解析失败")
```

## 解析流程

整体分为七步，**可以拆开用**：
1. `cutword` - 分词

分词的时候把lexicon的所有词头传进去了，这样能尽量保证分出来的东西准确一点

2. `run_merge_num` - 合并数字

这一步是把数字合并起来，因为分词的时候数字经常会被分，这个没法避免（总不能数字打个大表吧！）

3. `add_tag` - 打标

打的东西不止有标签，查表也在这步完成了

4. `first_parser` - 一步解析

实际的解析从这开始。叫一步解析是因为我有个思路文档（没传上来）里面把这个定为第一步。
这一步解析主要的作用是构建Struct结构。

5. `second_parser` - 二步解析

这一步解析主要的作用是填充Struct，通过查表和模板（就是那两个yaml）来把形式化的结构转换成具有实际内容的结构。

6. `third_parser` - 三步解析

这一步解析主要的作用是应用基准值、偏移量等需要数学计算的东西。

7. `to_datetime` - 解析为datetime

最后把结构转换成更常用的datetime。  
当然如果可以的话，我还是建议直接和三步解析生成的结构交互，把`instant_merge`设为True之后直接生成的结构相比datetime能有更多更丰富的信息。  

（题外话：`full_parse`的实现其实是这样的——
```python
to_datetime(*third_parser(second_parser(first_parser(add_tag(run_merge_num(cutter.cutword(text)))))))
```
括   号   叠   叠   乐）

# 欢迎PR
来点lexicon吧球球惹  
多交PR喵，多交PR谢谢喵！  

# 附录：`main.py`中测试样例的运行结果
```log
========================
2025年8月15日
cn2t:            2025-08-15 00:00:00 ~ 2025-08-16 00:00:00
dateparser:      2025-08-15 00:00:00
========================
贰零贰伍年捌月拾伍日
cn2t:            2025-08-15 00:00:00 ~ 2025-08-16 00:00:00
dateparser:      <解析失败>
========================
二〇二五年八月十五日
cn2t:            2025-08-15 00:00:00 ~ 2025-08-16 00:00:00
dateparser:      <解析失败>
========================
2025/08/15
cn2t:            2025-08-15 00:00:00 ~ 2025-08-16 00:00:00
dateparser:      2025-08-15 00:00:00
========================
2025年8月16日 14:30:45
cn2t:            2025-08-16 14:30:45 ~ 2025-08-16 14:30:46
dateparser:      2025-08-16 14:30:45
========================
2025-08-16 18:15:00
cn2t:            2025-08-16 18:15:00 ~ 2025-08-16 18:15:01
dateparser:      2025-08-16 18:15:00
========================
2025/08/16 23:59:59
cn2t:            2025-08-16 23:59:59 ~ 2025-08-17 00:00:00
dateparser:      2025-08-16 23:59:59
========================
二〇二五年八月十六日 下午三点半
cn2t:            2025-08-16 15:30:00 ~ 2025-08-16 15:31:00
dateparser:      <解析失败>
========================
二零二五年八月十六号 中午12点整
cn2t:            2025-08-16 12:00:00 ~ 2025-08-16 12:01:00
dateparser:      <解析失败>
========================
二五年8月16日 午夜12点
cn2t:            2025-08-17 00:00:00 ~ 2025-08-17 01:00:00
dateparser:      <解析失败>
========================
2025年8月16日 上午9时15分
cn2t:            2025-08-16 09:15:00 ~ 2025-08-16 09:16:00
dateparser:      <解析失败>
========================
2025-08-16 下午11:08
cn2t:            2025-08-16 23:08:00 ~ 2025-08-16 23:09:00
dateparser:      2025-08-16 23:08:00
========================
8月16日 凌晨3:20
cn2t:            2025-08-16 03:20:00 ~ 2025-08-16 03:21:00
dateparser:      <解析失败>
========================
8月16日 14:00
cn2t:            2025-08-16 14:00:00 ~ 2025-08-16 14:01:00
dateparser:      <解析失败>
========================
十二月三十一日 18:00
cn2t:            2025-12-31 18:00:00 ~ 2025-12-31 18:01:00
dateparser:      <解析失败>
========================
02月15日 09:30:00
cn2t:            2025-02-15 09:30:00 ~ 2025-02-15 09:30:01
dateparser:      <解析失败>
========================
16号晚上8点
cn2t:            2025-08-16 20:00:00 ~ 2025-08-16 21:00:00
dateparser:      <解析失败>
========================
01日 15:30
cn2t:            2025-08-01 15:30:00 ~ 2025-08-01 15:31:00
dateparser:      2025-08-17 15:30:00
========================
31日下午4点半
cn2t:            2025-08-31 16:30:00 ~ 2025-08-31 16:31:00
dateparser:      <解析失败>
========================
下午4点
cn2t:            2025-08-18 16:00:00 ~ 2025-08-18 17:00:00
dateparser:      <解析失败>
========================
上午10:15
cn2t:            2025-08-18 10:15:00 ~ 2025-08-18 10:16:00
dateparser:      2025-08-17 10:15:00
========================
23:45:30
cn2t:            2025-08-18 23:45:30 ~ 2025-08-18 23:45:31
dateparser:      2025-08-17 23:45:30
========================
今天
cn2t:            2025-08-18 00:00:00 ~ 2025-08-19 00:00:00
dateparser:      2025-08-18 00:38:48.657231
========================
明天凌晨
cn2t:            2025-08-19 00:00:00 ~ 2025-08-19 05:00:00
dateparser:      <解析失败>
========================
昨天中午
cn2t:            2025-08-17 12:00:00 ~ 2025-08-17 13:00:00
dateparser:      2025-08-17 12:00:00
========================
三天后
cn2t:            2025-08-21 00:00:00 ~ 2025-08-22 00:00:00
dateparser:      <解析失败>
========================
两周前
cn2t:            2025-08-04 00:00:00 ~ 2025-08-11 00:00:00
dateparser:      <解析失败>
========================
下个月5号
cn2t:            2025-09-05 00:00:00 ~ 2025-09-06 00:00:00
dateparser:      <解析失败>
========================
下周二
cn2t:            2025-08-26 00:00:00 ~ 2025-09-02 00:00:00
dateparser:      <解析失败>
========================
上周三上午10点
cn2t:            2025-08-13 10:00:00 ~ 2025-08-13 11:00:00
dateparser:      <解析失败>
========================
公历2025年8月16日
cn2t:            2025-08-16 00:00:00 ~ 2025-08-17 00:00:00
dateparser:      <解析失败>
========================
2025年8月
cn2t:            2025-08-01 00:00:00 ~ 2025-09-01 00:00:00
dateparser:      2025-08-17 00:00:00
========================
8月
cn2t:            2025-08-01 00:00:00 ~ 2025-09-01 00:00:00
dateparser:      2025-08-17 00:00:00
========================
2025/8/16 PM 3:45
cn2t:            2025-08-16 15:45:00 ~ 2025-08-16 15:46:00
dateparser:      <解析失败>
========================
0001年1月1日
cn2t:            2001-01-01 00:00:00 ~ 2001-01-02 00:00:00
dateparser:      0001-01-01 00:00:00
========================
9999年12月31日 23:59:59
cn2t:            9999-12-31 23:59:59 ~ 9999-12-31 23:59:59
dateparser:      9999-12-31 23:59:59
========================
2024年2月29日
cn2t:            2024-02-29 00:00:00 ~ 2024-03-01 00:00:00
dateparser:      2024-02-29 00:00:00
========================
2025年13月1日
cn2t:            <解析失败>
dateparser:      2025-01-13 00:00:00
========================
2025年2月30日
cn2t:            <解析失败>
dateparser:      <解析失败>
========================
昨天25点
cn2t:            <解析失败>
dateparser:      <解析失败>
========================
2025年农历八月十六
cn2t:            <解析失败>
dateparser:      <解析失败>
========================
无效时间格式
cn2t:            <解析失败>
dateparser:      <解析失败>
========================
2025年8月32日
cn2t:            <解析失败>
dateparser:      <解析失败>
========================
嘉靖十五年
cn2t:            1436-01-01 00:00:00 ~ 1437-01-01 00:00:00
dateparser:      <解析失败>
```
多交PR喵，多交PR谢谢喵  

注：“周二”被解析为一整周了。……我也不知道咋改所以就先这么撂着吧。起码开始日期是准确的不是嘛（逃